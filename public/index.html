<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seagold AR Business Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ==================== SCENE LAYERING ==================== */
    a-scene {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    /* ==================== VIDEO FEED ==================== */
    body > video.mindar-image-video {
      z-index: 0;
      transform: none;
      filter: contrast(1.2) saturate(1.1);
      -webkit-filter: contrast(1.2) saturate(1.1);
      image-rendering: crisp-edges;
    }
    
    /* ==================== INTERACTIVE ELEMENTS ==================== */
    .clickable {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .clickable:hover {
      opacity: 0.8;
    }
    
    /* ==================== LINK STYLES ==================== */
    .url-link {
      color: #0066cc;
      text-decoration: underline;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .url-link:hover {
      color: #004499;
      text-decoration: none;
    }
    
    /* ==================== DEBUG CONSOLE ==================== */
    #debug-console {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10000;
    }
    
    /* ==================== SCANNING UI ==================== */
    .mindar-ui-overlay .scanning::after {
      content: "";
      position: absolute;
      top: 25%;
      left: 25%;
      right: 25%;
      bottom: 25%;
      border: 2px dashed rgba(255,255,255,0.7);
      border-radius: 8px;
      pointer-events: none;
    }

    /* ==================== MAP SLIDE ANIMATION ==================== */
    .map-container {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.6rem;
      height: 0.4rem;
      transform: translateX(0.6rem);
      opacity: 0;
      transition: all 0.5s ease-out;
      pointer-events: none;
    }

    .map-container.visible {
      transform: translateX(0.7rem);
      opacity: 1;
      pointer-events: auto;
    }

    .map-toggle {
      position: absolute;
      right: 0.05rem;
      bottom: 0.05rem;
      width: 0.08rem;
      height: 0.08rem;
      background: #4a954e;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 5;
    }

    .map-toggle:hover {
      transform: scale(1.2);
      background: #3a853e;
    }
  </style>
</head>
<body>
  <!-- ==================== AR SCENE CONTAINER ==================== -->
  <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; 
                        autoStart: true; 
                        uiScanning: true; 
                        wasmPath: ./assets/mindar/;
                        filterMinCF: 0.01;
                        filterBeta: 0.001;"
           embedded 
           color-space="sRGB" 
           renderer="colorManagement: true, physicallyCorrectLights"
           device-orientation-permission-ui="enabled: true">

    <a-camera position="0 0 0"></a-camera>

    <!-- ==================== TARGET ANCHOR POINT ==================== -->
    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <!-- ==================== BUSINESS CARD ==================== -->
      <a-plane class="clickable" position="0 0 0" width="1" height="0.9" color="#f2ede3"
               onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"
               animation="property: position; to: 0 0.05 0; dur: 800; easing: easeOutElastic"
               shadow="receive: true">

        <!-- ==================== CARD CONTENT ==================== -->
        <a-text value="Seagold Dormitory"
                position="0 0.35 0.02" 
                align="center" 
                width="1.2" 
                color="#4a954e" 
                scale="1 1 1"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"></a-text>

        <a-text value="Comfort Away From Home"
                position="0 0.28 0.02"
                align="center"
                width="1"
                color="#d2a647"></a-text>

        <a-text value="📞 09225927385"
                position="-0.42 0.16 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="📧 seagold.service@gmail.com"
                position="-0.42 0.08 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="📍 3/F Fern Bldg, Sampaloc, Manila"
                position="-0.42 0.00 0.02"
                width="1"
                color="#333"></a-text>

        <!-- ==================== CLICKABLE WEB URL ==================== -->
        <a-text value="🌐 Seagold Dormitory (Facebook)"
                position="-0.42 -0.08 0.02"
                width="1"
                color="#0066cc"
                class="url-link"
                onclick="window.open('https://facebook.com/seagolddormitory', '_blank')"></a-text>

        <!-- ==================== MAP TOGGLE BUTTON ==================== -->
        <a-entity class="map-toggle" 
                 position="0.45 -0.35 0.02"
                 onclick="toggleMap()"></a-entity>

        <!-- ==================== SLIDING MAP CONTAINER ==================== -->
        <a-entity class="map-container" position="0.35 -0.2 0.02">
          <a-plane id="mapPlane" width="0.55" height="0.35" color="#ddd" material="shader: flat"></a-plane>
          <!-- You can add your image here later -->
          <!-- <a-image src="./assets/images/map-overlay.png" width="0.55" height="0.35"></a-image> -->
        </a-entity>

        <!-- ==================== CALL TO ACTION ==================== -->
        <a-text value="Visit Our Website"
                position="0 -0.42 0.02"
                align="center"
                width="0.8"
                color="#00bf63"
                class="clickable"
                animation="property: scale; to: 1.1 1.1 1; dir: alternate; dur: 1000; loop: true"
                onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"></a-text>
      </a-plane>
    </a-entity>
  </a-scene>

  <!-- ==================== DEBUG CONSOLE ==================== -->
  <div id="debug-console"></div>

  <script>
    // ==================== DEBUG SYSTEM ====================
    const debugConsole = document.getElementById('debug-console');
    function debugLog(message) {
      const entry = document.createElement('div');
      entry.textContent = `[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`;
      debugConsole.appendChild(entry);
      debugConsole.scrollTop = debugConsole.scrollHeight;
      console.log(message);
    }

    // ==================== MAP TOGGLE FUNCTION ====================
    function toggleMap() {
      const mapContainer = document.querySelector('.map-container');
      mapContainer.classList.toggle('visible');
      
      if (mapContainer.classList.contains('visible')) {
        debugLog("Map sliding out");
        loadMapTexture();
      } else {
        debugLog("Map sliding back");
      }
    }

    // ==================== VISIBILITY MANAGEMENT ====================
    const anchor = document.querySelector('#anchor');
    let visibilityGuardActive = false;
    let visibilityGuardInterval;

    function activateVisibilityGuard() {
      if (!anchor || visibilityGuardActive) return;
      
      visibilityGuardActive = true;
      debugLog("🛡️ Activating visibility guard");
      
      // Primary visibility enforcement
      anchor.setAttribute('visible', 'true');
      
      // Backup visibility method
      const backup = document.createElement('a-entity');
      backup.setAttribute('geometry', 'primitive: plane; width: 0.01; height: 0.01');
      backup.setAttribute('material', 'color: transparent; transparent: true; opacity: 0');
      backup.setAttribute('visible', 'true');
      anchor.appendChild(backup);
      
      // Continuous monitoring
      visibilityGuardInterval = setInterval(() => {
        if (anchor.getAttribute('visible') !== 'true') {
          debugLog("🛡️ Correcting visibility loss");
          anchor.setAttribute('visible', 'true');
          backup.setAttribute('visible', 'true');
        }
      }, 100);
      
      // Cleanup handler
      const cleanup = () => {
        clearInterval(visibilityGuardInterval);
        anchor.removeChild(backup);
        visibilityGuardActive = false;
        debugLog("🛡️ Visibility guard deactivated");
        anchor.removeEventListener('targetLost', cleanup);
      };
      
      anchor.addEventListener('targetLost', cleanup, { once: true });
    }

    // ==================== AR SYSTEM INITIALIZATION ====================
    const scene = document.querySelector('a-scene');
    if (scene) {
      scene.addEventListener('arReady', () => {
        debugLog("AR system initialized");
        
        if (anchor) {
          anchor.addEventListener('targetFound', () => {
            debugLog("🎯 Target detected");
            activateVisibilityGuard();
            
            // Post-render visibility verification
            requestAnimationFrame(() => {
              if (anchor.getAttribute('visible') !== 'true') {
                debugLog("🔄 Visibility verification");
                anchor.setAttribute('visible', 'true');
              }
            });
          });
        }
      });
    }

    // ==================== MAP SYSTEM ====================
    const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
    const dormPos = { lat: 14.603919, lng: 120.987760 };

    function createMapUrl(userPos) {
      const fallbackUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=17&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}&key=${GOOGLE_API_KEY}`;
      
      try {
        return `http://localhost:3001/api/staticmap?userLat=${userPos.lat}&userLng=${userPos.lng}` || fallbackUrl;
      } catch (e) {
        debugLog(`Map error: ${e.message}`);
        return fallbackUrl;
      }
    }

    function loadMapTexture() {
      const mapPlane = document.getElementById("mapPlane");
      if (!mapPlane) return;

      // Only load if not already loaded
      if (mapPlane.hasAttribute('material') && mapPlane.getAttribute('material').src) {
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          const mapUrl = createMapUrl(userPos);
          
          const img = new Image();
          img.onload = function() {
            mapPlane.setAttribute("material", "shader: flat; src: " + mapUrl);
            debugLog(`🗺️ Map loaded: ${mapUrl}`);
          };
          img.src = mapUrl;
        },
        (error) => {
          debugLog("Geolocation error, using default map");
          const defaultUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=15&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}`;
          mapPlane.setAttribute("material", "shader: flat; src: " + defaultUrl);
        }
      );
    }

    // ==================== GEOLOCATION ====================
    debugLog("Initializing geolocation...");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          debugLog(`📍 Location: ${userPos.lat}, ${userPos.lng}`);
        },
        (err) => {
          debugLog(`❌ Geolocation error: ${err.message}`);
        },
        { enableHighAccuracy: true, timeout: 5000 }
      );
    } else {
      debugLog("❌ Geolocation unavailable");
    }

    // ==================== STARTUP ====================
    window.addEventListener('load', () => {
      debugLog("System ready");
      if (!window.AFRAME) debugLog("❌ A-Frame missing");
      if (!window.MINDAR) debugLog("❌ MindAR missing");
    });
  </script>
</body>
</html>