<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seagold AR Business Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="ar-loader">
    <div class="loader-container">
      <img src="./assets/images/seagold-logo.png" class="loader-logo" alt="Seagold Dormitory">
      <div class="loader-spinner">
        <div class="loader-spinner-inner"></div>
        <div class="loader-spinner-inner"></div>
        <div class="loader-spinner-inner"></div>
      </div>
      <h3 class="loader-text">Seagold AR Experience</h3>
      <p class="loader-subtext">Initializing augmented reality for your business dormitory card</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
  </div>
  <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true; uiScanning: true; wasmPath: ./assets/mindar/; filterMinCF: 0.01; filterBeta: 0.001;"
         cursor="rayOrigin: mouse"
         embedded color-space="sRGB"
         renderer="colorManagement: true, physicallyCorrectLights"
         device-orientation-permission-ui="enabled: true"
         shadow="type: pcfsoft"
         screenshot="">

  <!-- Lighting -->
  <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="-0.5 1 1"></a-entity>
  <a-entity light="type: ambient; color: #ffffff; intensity: 0.3"></a-entity>

  <!-- Assets -->
  <a-assets>
    <canvas id="cardGradient" width="100" height="100"></canvas>
    <video id="topVideo" src="./assets/images/promo.mp4" loop crossorigin="anonymous" muted autoplay playsinline></video>
    <img id="leftImage" src="./assets/images/seagold.png" crossorigin="anonymous">
    <img id="cardFront" src="./assets/images/ARCARD.png" crossorigin="anonymous">
    <img id="cardBack" src="./assets/images/targets-target.png" crossorigin="anonymous">
  </a-assets>

  <!-- Camera -->
  <a-camera position="0 0 0" raycaster="objects: .clickable" cursor="fuse: false; rayOrigin: mouse;"></a-camera>

  <!-- FRONT SIDE AR -->
  <a-entity id="anchorFront" mindar-image-target="targetIndex: 0">

    <!-- Video (Right Side, Slides First) -->
    <a-video id="topVideoEntity" src="#topVideo" width="0.8" height="0.45" position="0 0.2 0.01" visible="false"
             geometry="primitive: plane; depth: 0.05"
             material="side: double; shader: flat"
             animation__slideout="property: position; to: 1.2 0.2 0.01; dur: 2500; delay: 800; easing: easeOutCubic; startEvents: startSlideOut"
             animation__visible="property: visible; to: true; startEvents: startSlideOut"
             event-set__mouseenter="_event: mouseenter; scale: 1.05 1.05 1"
             event-set__mouseleave="_event: mouseleave; scale: 1 1 1">
    </a-video>

    <a-image  id="leftImageEntity" class="clickable glow-pulse" src="#leftImage"
              width="0.6" height="0.4" position="0 0.2 -0.1" visible="false"
              geometry="primitive: box; depth: 0.03"
              material="side: front; metalness: 0.3; roughness: 0.7"
              animation__slideout="property: position; to: -1.2 0.2 0.01; dur: 2500; delay: 800; easing: easeOutCubic; startEvents: startSlideOut"
              animation__visible="property: visible; to: true; startEvents: startSlideOut"
              event-set__mouseenter="_event: mouseenter; scale: 1.05 1.05 1"
              event-set__mouseleave="_event: mouseleave; scale: 1 1 1">
    </a-image>


    <!-- 3D Card -->
    <a-box id="cardBox" class="clickable glow-pulse" position="0 0.2 0" depth="0.03" height="0.7" width="1.1"
           material="src: #cardFront; side: front; metalness: 0.4; roughness: 0.6"
           shadow="receive: true"
           animation__entrance="property: scale; from: 0 0 0; to: 1 1 1; dur: 600; easing: easeOutBack; startEvents: startSlideOut">
      <a-material src="#cardBack" side="back"></a-material>
      <a-material color="#f2ede3" side="left"></a-material>
      <a-material color="#f2ede3" side="right"></a-material>
      <a-material color="#f2ede3" side="top"></a-material>
      <a-material color="#f2ede3" side="bottom"></a-material>
    </a-box>

    <!-- Flip Hint -->
    <a-text id="tapHint" value="Tap to Flip" position="0 1.2 0.05" visible="false"
            color="#fff" align="center" width="1.5" opacity="0.8"
            animation__fade="property: opacity; to: 0.3; dir: alternate; loop: true; dur: 1500">
    </a-text>

    <!-- Snapshot -->
    <a-plane id="snapBtn" class="clickable" position="0 -0.8 0.02" width="0.3" height="0.12" color="#222"
             material="shader: flat; opacity: 0.9"
             event-set__mouseenter="_event: mouseenter; scale: 1.05 1.05 1"
             event-set__mouseleave="_event: mouseleave; scale: 1 1 1">
      <a-text value="ðŸ“· Save" align="center" width="1" color="#fff" position="0 0 0.01"></a-text>
    </a-plane>

    <!-- Visit Button -->
    <a-plane id="visitPlane" class="clickable" position="0 -0.45 0.02"
             width="0.6" height="0.15" color="#00bf63"
             material="shader: flat; transparent: false; opacity: 0.95"
             animation="property: scale; to: 1.05 1.05 1; dir: alternate; loop: true; dur: 1200">
      <a-text class="clickable" value="VISIT OUR WEBSITE" align="center" width="0.8" color="#ffffff"
              font-family="Poppins" font-weight="600" position="0 0 0.02">
      </a-text>
    </a-plane>

  </a-entity>

  <!-- BACK SIDE AR -->
  <a-entity id="anchorBack" mindar-image-target="targetIndex: 1">
    <a-image id="backARImage" src="#leftImage" width="1" height="0.6" position="0 0.2 0.01" visible="false"
             geometry="primitive: plane; depth: 0.02"
             material="side: double; metalness: 0.3; roughness: 0.7"
             animation__slideout="property: position; to: 0 1 0.01; dur: 1800; delay: 300; easing: easeOutBack; startEvents: startSlideOut"
             animation__visible="property: visible; to: true; startEvents: startSlideOut"
             animation__float="property: position; dir: alternate; dur: 4000; loop: true; to: 0 1.05 0.01; easing: easeInOutSine">
    </a-image>
  </a-entity>

</a-scene>

  <script>
    function simulateLoading() {
      const progressFill = document.getElementById('progress-fill');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('ar-loader').style.opacity = 0;
            setTimeout(() => {
              document.getElementById('ar-loader').style.display = 'none';
            }, 500);
          }, 300);
        }
        progressFill.style.width = `${progress}%`;
      }, 300);
    }

    const debugConsole = document.getElementById('debug-console');
    function debugLog(msg) {
      if (!debugConsole) return;
      if (debugConsole.children.length > 50) {
        debugConsole.removeChild(debugConsole.firstChild);
      }
      const entry = document.createElement('div');
      entry.textContent = `[DEBUG ${new Date().toLocaleTimeString()}]: ${msg}`;
      debugConsole.appendChild(entry);
      debugConsole.scrollTop = debugConsole.scrollHeight;
      console.log(msg);
    }

    function setupVisitButton() {
      const visitPlane = document.getElementById('visitPlane');
      if (visitPlane) {
        visitPlane.addEventListener('mousedown', () => {
          debugLog("Visit button clicked. Redirecting to website...");
          fetch('https://seagold-dormitory.vercel.app/api/log-visit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              timestamp: new Date().toISOString(),
              action: 'visit-button-clicked',
              source: 'seagold-ar-business-card'
            })
          }).catch(err => debugLog('Analytics log failed: ' + err.message));
          const link = document.createElement('a');
          link.href = 'https://seagold-dormitory.vercel.app';
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }
    }

    function setupMobileInteractions() {
      const clickables = document.querySelectorAll('.clickable');
      clickables.forEach(el => {
        el.addEventListener('touchstart', function (e) {
          e.preventDefault();
          this.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
        }, { passive: false });
      });
      debugLog("Touch compatibility initialized.");
    }

    function handleVideoPlayback() {
      const video = document.querySelector('#topVideo');
      if (!video) return;
      const tryPlay = () => {
        if (video.paused && video.readyState >= 3) {
          video.play().then(() => {
            debugLog("Video playing");
          }).catch(e => {
            debugLog("Video play error: " + e.message);
            setTimeout(tryPlay, 1000);
          });
        }
      };
      tryPlay();
    }

    function setupCardFlip() {
      const card = document.querySelector('#cardBox');
      if (!card) return;
      let isFlipped = false;
      card.addEventListener('mousedown', () => {
        isFlipped = !isFlipped;
        const newRotation = isFlipped ? '0 180 0' : '0 0 0';
        card.setAttribute('animation__flip', {
          property: 'rotation',
          to: newRotation,
          dur: 1000,
          easing: 'easeOutElastic',
          elasticity: 400
        });
        debugLog("Card flipped to: " + newRotation);
      });
    }

    window.addEventListener('load', () => {
      debugLog("App loaded.");
      simulateLoading();
      setupVisitButton();
      setupMobileInteractions();
      setupCardFlip();

      const scene = document.querySelector('a-scene');
      const anchorFront = document.getElementById('anchorFront');
      const anchorBack = document.getElementById('anchorBack');

      if (scene) {
        scene.addEventListener('arReady', () => {
          debugLog("AR system ready");

          // FRONT MARKER
          if (anchorFront) {
            anchorFront.addEventListener('targetFound', () => {
              debugLog("Front marker detected. Launching smooth sequence...");

              const videoEl = document.querySelector('#topVideoEntity');
              const leftEl = document.querySelector('#leftImageEntity');
              const cardBox = document.querySelector('#cardBox');
              const hint = document.querySelector('#tapHint');

              videoEl.emit('startSlideOut');

              videoEl.addEventListener('animationcomplete__slideout', () => {
                debugLog("Video slide complete");
                handleVideoPlayback();
                leftEl.emit('startSlideOut');

                leftEl.addEventListener('animationcomplete__slideout', () => {
                  debugLog("Left image slide complete");
                  cardBox.emit('startSlideOut');

                  cardBox.addEventListener('animationcomplete__entrance', () => {
                    if (hint) hint.setAttribute('visible', 'true');
                  }, { once: true });

                }, { once: true });

              }, { once: true });
            });

            anchorFront.addEventListener('targetLost', () => {
              debugLog("Front marker lost. Resetting AR elements...");

              ['#leftImageEntity', '#topVideoEntity'].forEach(id => {
                const el = document.querySelector(id);
                if (el) {
                  el.setAttribute('visible', 'false');
                  el.setAttribute('position', '0 0.2 0.01');
                }
              });

              const video = document.querySelector('#topVideo');
              if (video) {
                video.pause();
                video.currentTime = 0;
              }

              const card = document.querySelector('#cardBox');
              if (card) {
                card.setAttribute('rotation', '0 0 0');
                card.removeAttribute('animation__flip');
              }

              const hint = document.getElementById('tapHint');
              if (hint) hint.setAttribute('visible', 'false');
            });
          }

          // BACK MARKER
          if (anchorBack) {
            anchorBack.addEventListener('targetFound', () => {
              debugLog("Back marker detected");
              document.querySelector('#backARImage').emit('startSlideOut');
            });

            anchorBack.addEventListener('targetLost', () => {
              debugLog("Back marker lost");
              const backImg = document.querySelector('#backARImage');
              if (backImg) {
                backImg.setAttribute('visible', 'false');
                backImg.setAttribute('position', '0 0.2 0.01');
              }
            });
          }
        });
      }
    });
  </script>
</body>
</html>
