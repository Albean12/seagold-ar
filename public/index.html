<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seagold AR Business Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ADDED CRITICAL FIXES */
    a-scene {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: auto;
    }
    
    body > video.mindar-image-video {
      z-index: 0 !important;
    }
    
    /* Your existing styles */
    .clickable {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .clickable:hover {
      opacity: 0.8;
    }
    .dorm-info {
      font-family: Arial;
      color: #333;
      line-height: 1.2;
    }
    body > video.mindar-image-video {
      filter: contrast(1.2) saturate(1.1) !important;
      -webkit-filter: contrast(1.2) saturate(1.1) !important;
      image-rendering: crisp-edges !important;
    }
    .mindar-ui-overlay .scanning::after {
      content: "";
      position: absolute;
      top: 25%;
      left: 25%;
      right: 25%;
      bottom: 25%;
      border: 2px dashed rgba(255,255,255,0.7);
      border-radius: 8px;
      pointer-events: none;
    }
    #debug-console {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; 
                        autoStart: true; 
                        uiScanning: true; 
                        wasmPath: ./assets/mindar/;
                        filterMinCF: 0.01;
                        filterBeta: 0.001;"
           embedded 
           color-space="sRGB" 
           renderer="colorManagement: true, physicallyCorrectLights"
           device-orientation-permission-ui="enabled: true">

    <a-camera position="0 0 0"></a-camera>

    <!-- Anchor element remains unchanged but will work now -->
    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <!-- All your existing card content remains exactly the same -->
      <a-plane class="clickable" position="0 0 0" width="1" height="0.9" color="#f2ede3"
               onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"
               animation="property: position; to: 0 0.05 0; dur: 800; easing: easeOutElastic"
               shadow="receive: true">

        <!-- 3D Brand Title -->
        <a-text value="Seagold Dormitory"
                position="0 0.35 0.02" 
                align="center" 
                width="1.2" 
                color="#4a954e" 
                scale="1 1 1"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"></a-text>

        <!-- Slogan -->
        <a-text value="Comfort Away From Home"
                position="0 0.28 0.02"
                align="center"
                width="1"
                color="#d2a647"></a-text>

        <!-- Contact Info -->
        <a-text value="üìû 09225927385"
                position="-0.42 0.16 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="üìß seagold.service@gmail.com"
                position="-0.42 0.08 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="üìç 3/F Fern Bldg, Sampaloc, Manila"
                position="-0.42 0.00 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="üåê Seagold Dormitory (Facebook)"
                position="-0.42 -0.08 0.02"
                width="1"
                color="#333"></a-text>

        <!-- Dynamic Map -->
        <a-plane id="mapPlane" position="0.35 -0.25 0.04" width="0.5" height="0.3" color="#ddd"
                 material="shader: flat"
                 animation="property: rotation; to: 0 0 10; dur: 2000; dir: alternate; loop: true"></a-plane>

        <!-- Website CTA -->
        <a-text value="Visit Our Website"
                position="0 -0.42 0.02"
                align="center"
                width="0.8"
                color="#00bf63"
                class="clickable"
                animation="property: scale; to: 1.1 1.1 1; dir: alternate; dur: 1000; loop: true"
                onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"></a-text>
      </a-plane>
    </a-entity>
  </a-scene>

  <div id="debug-console"></div>

  <script>
    // Enhanced debug system with visibility monitoring
    const debugConsole = document.getElementById('debug-console');
    function debugLog(message) {
      const entry = document.createElement('div');
      entry.textContent = `[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`;
      debugConsole.appendChild(entry);
      debugConsole.scrollTop = debugConsole.scrollHeight;
      console.log(message);
    }

    // ADDED: Visibility monitoring function
    function monitorAnchorVisibility(anchor) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'visible') {
            debugLog(`üîç Anchor visibility changed to: ${anchor.getAttribute('visible')}`);
          }
        });
      });
      
      observer.observe(anchor, {
        attributes: true,
        attributeFilter: ['visible']
      });
    }

    // System readiness checks
    function checkSystemReadiness() {
      if (!window.AFRAME) {
        debugLog("‚ùå Critical Error: A-Frame not loaded");
        return false;
      }
      if (!window.MINDAR) {
        debugLog("‚ùå Critical Error: MindAR not loaded");
        return false;
      }
      return true;
    }

    debugLog("Initializing AR application...");
    if (!checkSystemReadiness()) {
      debugLog("Application cannot start due to missing dependencies");
    }

    // DOM element references
    const mapPlane = document.getElementById("mapPlane");
    const scene = document.querySelector('a-scene');
    const anchor = document.querySelector('#anchor');

    if (!mapPlane) debugLog("‚ö†Ô∏è Warning: Could not find mapPlane element");
    if (!scene) debugLog("‚ö†Ô∏è Warning: Could not find a-scene element");
    if (!anchor) {
      debugLog("‚ö†Ô∏è Warning: Could not find anchor element");
    } else {
      // ADDED: Start monitoring anchor visibility
      monitorAnchorVisibility(anchor);
    }

    // Enhanced scanning UI
    const scanningElement = document.querySelector('.mindar-ui-overlay .scanning');
    if (scanningElement) {
      scanningElement.insertAdjacentHTML(
        'beforeend',
        '<div style="margin-top: 12px; color: white; text-align: center;">Hold steady 30cm from card</div>'
      );
      debugLog("Added scanning instructions to UI");
    }

    // AR Event Handlers
    if (scene) {
      scene.addEventListener('arReady', () => {
        debugLog("AR system is ready");
        const video = document.querySelector('video.mindar-image-video');
        if (video) {
          video.addEventListener('play', () => {
            video.style.filter = 'contrast(1.2) saturate(1.2)';
            debugLog("Video stream started, applied filters");
          });
        }
        
        if (anchor) {
          anchor.addEventListener('targetFound', () => {
            debugLog("‚úÖ Image target detected - content should be visible");
            debugLog(`Anchor visibility: ${anchor.getAttribute('visible')}`);
            // ADDED: Force visibility check
            setTimeout(() => {
              debugLog(`Post-detection visibility check: ${anchor.getAttribute('visible')}`);
            }, 100);
          });
          anchor.addEventListener('targetLost', () => {
            debugLog("‚ùå Image target lost - content hidden");
          });
        }
      });

      scene.addEventListener('renderstart', () => {
        debugLog("A-Frame rendering started");
        if (document.querySelector('video.mindar-image-video')) {
          debugLog("Video element found and active");
        }
      });
    }

    // Your existing map and geolocation functionality remains unchanged
    const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
    const dormPos = { lat: 14.603919, lng: 120.987760 };

    function createSimpleMapUrl(userPos) {
      const fallbackUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=17&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}&key=${GOOGLE_API_KEY}`;
      
      try {
        return `http://localhost:3001/api/staticmap?userLat=${userPos.lat}&userLng=${userPos.lng}` || fallbackUrl;
      } catch (e) {
        debugLog(`Map URL generation error: ${e.message}`);
        return fallbackUrl;
      }
    }

    function setMapTexture(url) {
      if (!mapPlane) {
        debugLog("‚ö†Ô∏è Cannot set map texture - mapPlane not found");
        return;
      }

      const img = new Image();
      img.onload = function() {
        mapPlane.setAttribute("material", "shader: flat; src: " + url);
        debugLog(`Map texture loaded successfully: ${url}`);
      };
      img.onerror = function() {
        debugLog(`‚ö†Ô∏è Failed to load map image from ${url}, using color fallback`);
        mapPlane.setAttribute("color", "#4a954e");
        mapPlane.removeAttribute("material");
      };
      img.src = url;
    }

    // Geolocation with improved error handling
    debugLog("Attempting to get geolocation...");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          debugLog(`üìç User position obtained: ${JSON.stringify(userPos)}`);
          const mapUrl = createSimpleMapUrl(userPos);
          debugLog(`üó∫Ô∏è Generated map URL: ${mapUrl}`);
          setMapTexture(mapUrl);
        },
        (err) => {
          debugLog(`‚ùå Geolocation error: ${err.message}`);
          const fallbackUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=15&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}&key=${GOOGLE_API_KEY}`;
          setMapTexture(fallbackUrl);
          debugLog("Using fallback map image");
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    } else {
      debugLog("‚ùå Geolocation not supported by browser");
      const fallbackUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=15&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}&key=${GOOGLE_API_KEY}`;
      setMapTexture(fallbackUrl);
    }

    // Final initialization check
    window.addEventListener('load', () => {
      debugLog("Page fully loaded");
      debugLog(`A-Frame ${AFRAME.version} loaded`);
      debugLog(`MindAR ${MINDAR.VERSION} loaded`);
      
      if (anchor) {
        debugLog(`Anchor initialized with targetIndex: ${anchor.components['mindar-image-target'].targetIndex}`);
      }
    });
  </script>
</body>
</html>