<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seagold AR Business Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="ar-loader">
    <div class="loader-container">
      <img src="./assets/images/seagold-logo.png" class="loader-logo" alt="Seagold Dormitory">
      <div class="loader-spinner">
        <div class="loader-spinner-inner"></div>
        <div class="loader-spinner-inner"></div>
        <div class="loader-spinner-inner"></div>
      </div>
      <h3 class="loader-text">Seagold AR Experience</h3>
      <p class="loader-subtext">Initializing augmented reality for your business dormitory card</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
  </div>

  <a-scene mindar-image="imageTargetSrc: ./assets/card.mind; autoStart: true; uiScanning: true; wasmPath: ./assets/mindar/; filterMinCF: 0.01; filterBeta: 0.001;"
           cursor="rayOrigin: mouse"
           embedded color-space="sRGB"
           renderer="colorManagement: true, physicallyCorrectLights"
           device-orientation-permission-ui="enabled: true"
           shadow="type: pcfsoft"
           screenshot="">
    <!-- Lighting -->
    <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="-0.5 1 1"></a-entity>
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.3"></a-entity>

    <!-- Assets -->
    <a-assets>
      <canvas id="cardGradient" width="100" height="100"></canvas>
      <video id="topVideo" src="./assets/images/ROOMS.mp4" loop crossorigin="anonymous" muted autoplay playsinline></video>
      <video id="leftVideo" src="./assets/images/FACILITY.mp4" loop crossorigin="anonymous" muted autoplay playsinline></video>
      <img id="cardFront" src="./assets/images/ARCARD.png" crossorigin="anonymous">
      <img id="cardBack" src="./assets/images/targets-target.png" crossorigin="anonymous">
    </a-assets>

    <!-- Camera -->
    <a-camera position="0 0 0"
              raycaster="objects: .clickable; far: 100;"
              cursor="fuse: false; rayOrigin: mouse;"></a-camera>

    <!-- FRONT SIDE AR -->
    <a-entity id="anchorFront" mindar-image-target="targetIndex: 0">

      <!-- Video (Right Slide Out) -->
      <a-entity id="topVideoEntity" geometry="primitive: box; width: 0.8; height: 0.45; depth: 0.03"
                material="shader: flat; src: #topVideo; side: double"
                position="0 0.2 -0.1" visible="false"
                animation__slideout="property: position; to: 1.2 0.2 0.01; dur: 2500; delay: 800; easing: easeOutCubic; startEvents: startSlideOut"
                animation__visible="property: visible; to: true; startEvents: startSlideOut">
      </a-entity>

      <!-- Left Video -->
      <a-entity id="leftVideoEntity" class="clickable glow-pulse"
                geometry="primitive: box; width: 0.6; height: 0.4; depth: 0.03"
                material="shader: flat; src: #leftVideo; side: double"
                position="0 0.2 -0.1" visible="false"
                animation__slideout="property: position; to: -1.2 0.2 0.01; dur: 2500; delay: 800; easing: easeOutCubic; startEvents: startSlideOut"
                animation__visible="property: visible; to: true; startEvents: startSlideOut">
      </a-entity>

      <!-- Main Card -->
      <a-box id="cardBox" class="clickable glow-pulse" position="0 0.2 0" depth="0.03" height="0.7" width="1.1"
             material="src: #cardFront; side: front; metalness: 0.4; roughness: 0.6"
             shadow="receive: true"
             animation__entrance="property: scale; from: 0 0 0; to: 1 1 1; dur: 600; easing: easeOutBack; startEvents: startSlideOut">
        <a-material src="#cardBack" side="back"></a-material>
        <a-material color="#f2ede3" side="left"></a-material>
        <a-material color="#f2ede3" side="right"></a-material>
        <a-material color="#f2ede3" side="top"></a-material>
        <a-material color="#f2ede3" side="bottom"></a-material>
      </a-box>

      <!-- Website Button (Visual Only) -->
      <a-plane id="visitPlane" position="0 -0.45 0.15"
               width="0.6" height="0.15" color=\"#00bf63\"
               material="shader: flat; transparent: false; opacity: 0.95; side: double">
        <a-text value="VISIT OUR WEBSITE"
                align="center"
                width="0.8"
                color="#ffffff"
                font-family="Poppins"
                font-weight="600"
                position="0 0 0.02"
                pointer-events="none">
        </a-text>
      </a-plane>
    </a-entity>
    <!-- BACK SIDE AR (Map Panel) -->
    <a-entity id="anchorBack" mindar-image-target="targetIndex: 1">
      <a-box id="mapPlane"
             position="0 0.2 -0.1"
             width="1.1" height="0.7" depth="0.03"
             visible="false"
             material="shader: standard; metalness: 0.3; roughness: 0.6; side: double"
             shadow="receive: true"
             animation__pop="property: position; from: 0 0.2 -0.1; to: 0 0.2 0.01; dur: 1200; easing: easeOutBack; startEvents: startMapAnim"
             animation__scale="property: scale; from: 0.8 0.8 0.8; to: 1 1 1; dur: 1200; easing: easeOutCubic; startEvents: startMapAnim"
             animation__visible="property: visible; to: true; startEvents: startMapAnim">
      </a-box>
    </a-entity>

    <div id="debug-console"></div>

    <script>
      const debugConsole = document.getElementById('debug-console');
      function debugLog(msg) {
        if (!debugConsole) return;
        const entry = document.createElement('div');
        entry.textContent = `[DEBUG ${new Date().toLocaleTimeString()}]: ${msg}`;
        debugConsole.appendChild(entry);
        debugConsole.scrollTop = debugConsole.scrollHeight;
        console.log(msg);
      }

      function simulateLoading() {
        const progressFill = document.getElementById('progress-fill');
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            setTimeout(() => {
              document.getElementById('ar-loader').style.opacity = 0;
              setTimeout(() => {
                document.getElementById('ar-loader').style.display = 'none';
              }, 500);
            }, 300);
          }
          progressFill.style.width = `${progress}%`;
        }, 300);
      }

      function setMapTexture(url) {
        const mapPlane = document.getElementById("mapPlane");
        const secureUrl = url.startsWith('http:') ? url.replace('http:', 'https:') : url;
        const img = new Image();
        img.onload = () => {
          mapPlane.setAttribute("material", `shader: flat; src: ${secureUrl}`);
          mapPlane.setAttribute("visible", true);
        };
        img.onerror = () => {
          mapPlane.setAttribute("material", "shader: flat; color: #4a954e");
          mapPlane.setAttribute("visible", true);
        };
        img.src = secureUrl;
      }

      function loadMapWithGeolocation() {
        const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
        const dormPos = { lat: 14.603919, lng: 120.987760 };
        const base = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=16&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}&key=${GOOGLE_API_KEY}`;

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const fullUrl = `${base}&markers=color:blue%7C${pos.coords.latitude},${pos.coords.longitude}`;
              setMapTexture(fullUrl);
            },
            () => setMapTexture(base),
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } else {
          setMapTexture(base);
        }
      }

      function setupCardFlip() {
        const card = document.querySelector('#cardBox');
        let isFlipped = false;
        card.addEventListener('mousedown', () => {
          isFlipped = !isFlipped;
          card.setAttribute('animation__flip', {
            property: 'rotation',
            to: isFlipped ? '0 180 0' : '0 0 0',
            dur: 1000,
            easing: 'easeOutElastic'
          });
        });
      }

      function handleVideoPlayback() {
        document.querySelectorAll('video').forEach(video => {
          const tryPlay = () => {
            if (video.paused && video.readyState >= 3) {
              video.play().catch(() => setTimeout(tryPlay, 1000));
            }
          };
          tryPlay();
        });
      }

      function enableTapRedirect() {
        debugLog("ðŸ“² Enabling AR scene tap redirect");
        const openSite = () => {
          debugLog("ðŸŒ Opening website from AR tap");
          window.open('https://seagold-dormitory.vercel.app', '_blank');
        };
        document.body.addEventListener('click', openSite, { once: true });
      }

      window.addEventListener('load', () => {
        simulateLoading();
        setupCardFlip();

        const scene = document.querySelector('a-scene');
        const anchorFront = document.getElementById('anchorFront');
        const anchorBack = document.getElementById('anchorBack');

        if (scene) {
          scene.addEventListener('arReady', () => {
            debugLog("âœ… AR system ready");

            if (anchorFront) {
              anchorFront.addEventListener('targetFound', () => {
                debugLog("ðŸŽ¯ Front marker detected");
                enableTapRedirect();

                const videoEl = document.querySelector('#topVideoEntity');
                const leftEl = document.querySelector('#leftVideoEntity');
                const cardBox = document.querySelector('#cardBox');

                videoEl.emit('startSlideOut');
                videoEl.addEventListener('animationcomplete__slideout', () => {
                  handleVideoPlayback();
                  leftEl.emit('startSlideOut');
                  leftEl.addEventListener('animationcomplete__slideout', () => {
                    cardBox.emit('startSlideOut');
                  }, { once: true });
                }, { once: true });
              });

              anchorFront.addEventListener('targetLost', () => {
                ['#leftVideoEntity', '#topVideoEntity'].forEach(id => {
                  const el = document.querySelector(id);
                  if (el) {
                    el.setAttribute('visible', 'false');
                    el.setAttribute('position', '0 0.2 -0.1');
                  }
                });

                document.querySelectorAll('video').forEach(video => {
                  video.pause();
                  video.currentTime = 0;
                });

                const card = document.querySelector('#cardBox');
                if (card) {
                  card.setAttribute('rotation', '0 0 0');
                  card.removeAttribute('animation__flip');
                }
              });
            }

            if (anchorBack) {
              anchorBack.addEventListener('targetFound', () => {
                document.querySelector('#mapPlane').emit('startMapAnim');
                loadMapWithGeolocation();
              });

              anchorBack.addEventListener('targetLost', () => {
                const mapEl = document.querySelector('#mapPlane');
                if (mapEl) {
                  mapEl.setAttribute('visible', false);
                  mapEl.setAttribute('position', '0 0.2 0.01');
                  mapEl.setAttribute('material', 'shader: flat; color: #4a954e');
                }
              });
            }
          });
        }
      });
    </script>
  </a-scene>
</body>
</html>
