<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Seagold AR Business Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
    <link rel="stylesheet" href="style.css" />
    <style>
      .clickable {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .clickable:hover {
        opacity: 0.8;
      }
      .dorm-info {
        font-family: Arial;
        color: #333;
        line-height: 1.2;
      }

      /* MindAR Video Fix */
      body > video.mindar-image-video {
        filter: contrast(1.2) saturate(1.1) !important;
        -webkit-filter: contrast(1.2) saturate(1.1) !important;
        image-rendering: crisp-edges !important;
      }

      /* Scanning Guide */
      .mindar-ui-overlay .scanning::after {
        content: "";
        position: absolute;
        top: 25%;
        left: 25%;
        right: 25%;
        bottom: 25%;
        border: 2px dashed rgba(255,255,255,0.7);
        border-radius: 8px;
        pointer-events: none;
      }

      /* Debug display box */
      #debug-log {
        position: fixed;
        top: 5px;
        left: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        font-size: 12px;
        padding: 8px;
        z-index: 999;
        max-width: 90%;
        font-family: monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <!-- On-screen debug box -->
    <div id="debug-log">üîç Debug Log:</div>

    <a-scene mindar-image="imageTargetSrc: ./assets/targets2.mind; 
                          autoStart: true; 
                          uiScanning: true; 
                          wasmPath: ./assets/mindar/;
                          filterMinCF: 0.01;
                          filterBeta: 0.001;"
             embedded color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights"
             device-orientation-permission-ui="enabled: true">
      <a-camera position="0 0 0"></a-camera>

      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <!-- Card base with website link -->
        <a-plane class="clickable" position="0 0 0" width="1" height="0.5" color="#00FFAA"
                onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')">
          
          <!-- Dormitory Information -->
          <a-entity class="dorm-info" position="-0.35 0.1 0.01" text="
            value: Seagold Dormitory\nCOMFORT AWAY FROM HOME\n\n09225927385\nseagold.service@gmail.com;
            width: 0.7;
            align: left;
            ">
          </a-entity>
          
          <!-- Map image that sticks to card -->
          <a-plane id="mapPlane" position="0.35 0.15 0.01" width="0.5" height="0.3" color="#ddd"></a-plane>
          
          <!-- Website CTA -->
          <a-text value="Visit Our Website" 
                 position="0 -0.2 0.01" 
                 align="center" 
                 width="0.8"
                 color="#0066cc"
                 class="clickable"
                 onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"></a-text>
        </a-plane>
      </a-entity>
    </a-scene>

    <script>
      const mapPlane = document.getElementById("mapPlane");
      const debugLog = document.getElementById("debug-log");

      function log(msg) {
        console.log(msg);
        debugLog.innerText += "\n" + msg;
      }

      // Scanning guide enhancement
      document.querySelector('.mindar-ui-overlay .scanning')?.insertAdjacentHTML(
        'beforeend',
        '<div style="margin-top: 12px; color: white; text-align: center;">Hold steady 30cm from card</div>'
      );

      // MindAR events for debugging
      const sceneEl = document.querySelector("a-scene");

      sceneEl.addEventListener("arReady", () => {
        log("‚úÖ MindAR is ready");
      });

      sceneEl.addEventListener("targetFound", () => {
        log("üéØ Target found");
      });

      sceneEl.addEventListener("targetLost", () => {
        log("‚ùå Target lost");
      });

      // Geolocation for map generation
      const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
      const dormPos = { lat: 14.603919, lng: 120.987760 };

      navigator.geolocation.getCurrentPosition((position) => {
        const userPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        log("üìç Geolocation success: " + JSON.stringify(userPos));
        const mapUrl = createSimpleMapUrl(userPos);
        log("üó∫Ô∏è Map URL: " + mapUrl);
        setMapTexture(mapUrl);
      }, (err) => {
        log("‚ö†Ô∏è Geolocation error: " + err.message);
      });

      function createSimpleMapUrl(userPos) {
        return `http://localhost:3001/api/staticmap?userLat=${userPos.lat}&userLng=${userPos.lng}`;
      }

      function setMapTexture(url) {
        mapPlane.setAttribute("material", "src", url);
      }
    </script>
  </body>
</html>
