<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seagold AR Business Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; 
                        autoStart: true; 
                        uiScanning: true; 
                        wasmPath: ./assets/mindar/;
                        filterMinCF: 0.01;
                        filterBeta: 0.001;"
           embedded 
           color-space="sRGB" 
           renderer="colorManagement: true, physicallyCorrectLights"
           device-orientation-permission-ui="enabled: true">

    <a-camera position="0 0 0"></a-camera>

    <!-- Hidden assets for animations -->
    <img id="topBanner" src="assets/top-banner.png" crossorigin="anonymous">
    <img id="leftPanel" src="assets/side-panel-left.png" crossorigin="anonymous">
    <img id="rightPanel" src="assets/images/seagoldpinicon.png" crossorigin="anonymous">
    <img id="mapFallback" src="assets/map-fallback.png" crossorigin="anonymous">
    <img id="mapOverlay" src="assets/map-overlay.png" crossorigin="anonymous">
    <img id="mapLoading" src="assets/map-loading.png" crossorigin="anonymous">

    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <!-- Animated Top Banner -->
      <a-image class="slide-in-top" src="#topBanner" position="0 0.6 0.01" width="1.2" height="0.2"
               animation="property: position; from: 0 1 0.01; to: 0 0.6 0.01; dur: 1000; easing: easeOutBack"></a-image>

      <!-- Main Card -->
      <a-plane class="clickable card-main" position="0 0 0" width="1" height="0.9" color="#f2ede3"
               onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"
               animation="property: position; to: 0 0.05 0; dur: 800; easing: easeOutElastic"
               shadow="receive: true">

        <!-- Animated Side Images -->
        <a-image class="slide-in-left" src="#leftPanel" position="-0.6 0 0.01" width="0.25" height="0.4"
                 animation="property: position; from: -1 0 0.01; to: -0.6 0 0.01; dur: 1200; delay: 500; easing: easeOutQuad"></a-image>
        
        <a-image class="slide-in-right" src="#rightPanel" position="0.6 0 0.01" width="0.25" height="0.4"
                 animation="property: position; from: 1 0 0.01; to: 0.6 0 0.01; dur: 1200; delay: 700; easing: easeOutQuad"></a-image>

        <!-- Main Content -->
        <a-text value="Seagold Dormitory"
                position="0 0.35 0.02" 
                align="center" 
                width="1.2" 
                color="#4a954e" 
                scale="1 1 1"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"></a-text>

        <a-text value="Comfort Away From Home"
                position="0 0.28 0.02"
                align="center"
                width="1"
                color="#d2a647"></a-text>

        <a-text value="üìû 09225927385"
                position="-0.42 0.16 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="üìß seagold.service@gmail.com"
                position="-0.42 0.08 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="üìç 3/F Fern Bldg, Sampaloc, Manila"
                position="-0.42 0.00 0.02"
                width="1"
                color="#333"></a-text>

        <a-text value="üåê Seagold Dormitory (Facebook)"
                position="-0.42 -0.08 0.02"
                width="1"
                color="#333"></a-text>

        <!-- Enhanced Map Section -->
        <a-plane id="mapPlane" position="0.35 -0.25 0.04" width="0.5" height="0.3" 
                 material="shader: flat; src: #mapLoading"
                 data-state="loading"
                 animation="property: rotation; to: 0 0 10; dur: 2000; dir: alternate; loop: true">
          <a-image class="map-overlay" src="#mapOverlay" width="0.5" height="0.3"></a-image>
        </a-plane>

        <a-text value="Visit Our Website"
                position="0 -0.42 0.02"
                align="center"
                width="0.8"
                color="#00bf63"
                class="clickable"
                animation="property: scale; to: 1.1 1.1 1; dir: alternate; dur: 1000; loop: true"
                onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"></a-text>
      </a-plane>
    </a-entity>
  </a-scene>

  <div id="debug-console"></div>

  <script>
    // Enhanced debug system
    const debugConsole = document.getElementById('debug-console');
    function debugLog(message) {
      const entry = document.createElement('div');
      entry.textContent = `[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`;
      debugConsole.appendChild(entry);
      debugConsole.scrollTop = debugConsole.scrollHeight;
      console.log(message);
    }

    // Animation Controller - FIXED
    const animationManager = {
      animations: [],
      add: function(el) {
        if (el.components && el.components.animation) {
          this.animations.push(el.components.animation);
        }
      },
      stopAll: function() {
        this.animations.forEach(anim => {
          try {
            if (anim && anim.stop) anim.stop();
          } catch(e) {
            debugLog(`‚ö†Ô∏è Animation stop error: ${e.message}`);
          }
        });
        this.animations = [];
      }
    };

    // Robust visibility enforcement - IMPROVED
    const visibilityManager = {
      interval: null,
      backupEntity: null,
      start: function(anchor) {
        this.stop();
        debugLog("üîß Starting visibility enforcement");
        
        anchor.setAttribute('visible', 'true');
        
        this.backupEntity = document.createElement('a-entity');
        this.backupEntity.setAttribute('geometry', 'primitive: plane; width: 0.01; height: 0.01');
        this.backupEntity.setAttribute('material', 'color: white; transparent: true; opacity: 0.001');
        anchor.appendChild(this.backupEntity);

        this.interval = setInterval(() => {
          if (anchor.getAttribute('visible') !== 'true') {
            debugLog("‚ö†Ô∏è Visibility lost - reapplying fix");
            anchor.setAttribute('visible', 'true');
            this.backupEntity.setAttribute('visible', 'true');
          }
        }, 500);
      },
      stop: function() {
        if (this.interval) clearInterval(this.interval);
        if (this.backupEntity && this.backupEntity.parentNode) {
          this.backupEntity.parentNode.removeChild(this.backupEntity);
        }
        debugLog("üîß Visibility enforcement ended");
      }
    };

    // Enhanced Map Functionality - FIXED
    const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
    const dormPos = { lat: 14.603919, lng: 120.987760 };

    function createSimpleMapUrl() {
      // Build URL with all required parameters
      const baseUrl = 'https://maps.googleapis.com/maps/api/staticmap';
      const params = new URLSearchParams({
        center: `${dormPos.lat},${dormPos.lng}`,
        zoom: '17',
        size: '400x300',
        scale: '2',
        maptype: 'roadmap',
        markers: `color:0xFF0000|${dormPos.lat},${dormPos.lng}`,
        key: GOOGLE_API_KEY
      });
      
      // Debug the generated URL
      const finalUrl = `${baseUrl}?${params.toString()}`;
      debugLog(`üó∫Ô∏è Generated Map URL: ${finalUrl.split('?')[0]}`);
      return finalUrl;
    }

    function setMapTexture(url) {
      const mapPlane = document.getElementById("mapPlane");
      if (!mapPlane) {
        debugLog("‚ö†Ô∏è Cannot set map texture - mapPlane not found");
        return;
      }

      // Create temporary debug image
      const debugImg = document.createElement('img');
      debugImg.style.position = 'fixed';
      debugImg.style.top = '10px';
      debugImg.style.left = '10px';
      debugImg.style.width = '200px';
      debugImg.style.zIndex = '100000';
      debugImg.style.border = '2px solid red';
      debugImg.src = url;
      document.body.appendChild(debugImg);
      setTimeout(() => document.body.removeChild(debugImg), 10000);

      const img = new Image();
      img.crossOrigin = "Anonymous";
      
      const loadTimeout = setTimeout(() => {
        debugLog("‚ö†Ô∏è Map loading timeout, using fallback");
        mapPlane.setAttribute("material", "shader: standard; src: #mapFallback");
        mapPlane.removeAttribute('data-state');
      }, 5000);

      img.onload = function() {
        clearTimeout(loadTimeout);
        try {
          // Verify image data
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          // Check if image has content
          const pixelData = ctx.getImageData(0, 0, 1, 1).data;
          if (pixelData[3] === 0) { // If alpha channel is 0 (fully transparent)
            throw new Error("Received blank image from API");
          }

          // Apply texture with standard shader for better rendering
          mapPlane.setAttribute("material", `shader: standard; src: ${url}; metalness: 0; roughness: 1`);
          mapPlane.removeAttribute('data-state');
          debugLog("üó∫Ô∏è Map texture loaded successfully");
        } catch(e) {
          debugLog(`‚ö†Ô∏è Error applying map texture: ${e.message}`);
          mapPlane.setAttribute("material", "shader: standard; src: #mapFallback");
          mapPlane.removeAttribute('data-state');
        }
      };
      
      img.onerror = function() {
        clearTimeout(loadTimeout);
        debugLog("‚ö†Ô∏è Failed to load map image, using fallback");
        mapPlane.setAttribute("material", "shader: standard; src: #mapFallback");
        mapPlane.removeAttribute('data-state');
      };
      
      img.src = url;
    }

    // AR Initialization - UPDATED
    const scene = document.querySelector('a-scene');
    if (scene) {
      scene.addEventListener('arReady', () => {
        debugLog("AR system ready");
        
        const anchor = document.querySelector('#anchor');
        if (!anchor) return;

        anchor.addEventListener('targetFound', () => {
          debugLog("üéØ Target found");
          visibilityManager.start(anchor);
          
          // Start animations properly
          document.querySelectorAll('[animation]').forEach(el => {
            animationManager.add(el);
            if (el.components.animation) {
              el.components.animation.play();
            }
          });

          // Load map with fresh URL each time
          const mapUrl = createSimpleMapUrl() + '&' + new Date().getTime(); // Cache busting
          debugLog(`üó∫Ô∏è Loading map...`);
          setMapTexture(mapUrl);
        });

        anchor.addEventListener('targetLost', () => {
          debugLog("üéØ Target lost");
          visibilityManager.stop();
          animationManager.stopAll();
        });
      });
    }

    // Initialization
    window.addEventListener('load', () => {
      debugLog("System initialized");
      if (!window.AFRAME || !window.MINDAR) {
        debugLog("‚ùå Missing required libraries");
      }
      
      // Initial map load
      const mapUrl = createSimpleMapUrl();
      setMapTexture(mapUrl);
    });

    // Global error handling
    window.addEventListener('error', (e) => {
      debugLog(`‚ö†Ô∏è Global error: ${e.message}`);
    });
  </script>
</body>
</html>