<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Seagold AR Business Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
    <link rel="stylesheet" href="style.css" />
    <style>
      .clickable {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .clickable:hover {
        opacity: 0.8;
      }
      .dorm-info {
        font-family: Arial;
        color: #333;
        line-height: 1.2;
      }

      /* MindAR Video Fix */
      body > video.mindar-image-video {
        filter: contrast(1.2) saturate(1.1) !important;
        -webkit-filter: contrast(1.2) saturate(1.1) !important;
        image-rendering: crisp-edges !important;
      }

      /* Scanning Guide */
      .mindar-ui-overlay .scanning::after {
        content: "";
        position: absolute;
        top: 25%;
        left: 25%;
        right: 25%;
        bottom: 25%;
        border: 2px dashed rgba(255,255,255,0.7);
        border-radius: 8px;
        pointer-events: none;
      }
      
      /* Debug console */
      #debug-console {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 10000;
      }
    </style>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: ./assets/try.mind; 
                          autoStart: true; 
                          uiScanning: true; 
                          wasmPath: ./assets/mindar/;
                          filterMinCF: 0.01;
                          filterBeta: 0.001;"
             embedded 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights"
             device-orientation-permission-ui="enabled: true">

      <a-camera position="0 0 0"></a-camera>

      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <!-- Card base with website link -->
        <a-plane class="clickable" position="0 0 0" width="1" height="0.5" color="#00FFAA"
                onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')">

          <!-- Dormitory Information -->
          <a-entity class="dorm-info" position="-0.35 0.1 0.01" text="
            value: Seagold Dormitory\nCOMFORT AWAY FROM HOME\n\n09225927385\nseagold.service@gmail.com;
            width: 0.7;
            align: left;">
          </a-entity>

          <!-- Map image that sticks to card -->
          <a-plane id="mapPlane" position="0.35 0.15 0.01" width="0.5" height="0.3" color="#ddd"></a-plane>

          <!-- Website CTA -->
          <a-text value="Visit Our Website" 
                 position="0 -0.2 0.01" 
                 align="center" 
                 width="0.8"
                 color="#0066cc"
                 class="clickable"
                 onclick="window.open('https://seagold-dormitory.vercel.app', '_blank')"></a-text>
        </a-plane>
      </a-entity>
    </a-scene>

    <div id="debug-console"></div>

    <script>
      const debugConsole = document.getElementById('debug-console');
      function debugLog(message) {
        const entry = document.createElement('div');
        entry.textContent = `[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`;
        debugConsole.appendChild(entry);
        debugConsole.scrollTop = debugConsole.scrollHeight;
        console.log(message);
      }

      debugLog("Initializing AR application...");
      
      const mapPlane = document.getElementById("mapPlane");
      if (!mapPlane) debugLog("‚ùå Error: Could not find mapPlane element");

      // Enhanced scan instruction
      const scanningElement = document.querySelector('.mindar-ui-overlay .scanning');
      if (scanningElement) {
        scanningElement.insertAdjacentHTML(
          'beforeend',
          '<div style="margin-top: 12px; color: white; text-align: center;">Hold steady 30cm from card</div>'
        );
        debugLog("Added scanning instructions to UI");
      } else {
        debugLog("‚ùå Could not find scanning UI element");
      }

      // Camera quality monitor
      const scene = document.querySelector('a-scene');
      if (scene) {
        scene.addEventListener('arReady', () => {
          debugLog("AR system is ready");
          const video = document.querySelector('video.mindar-image-video');
          if (video) {
            video.addEventListener('play', () => {
              video.style.filter = 'contrast(1.3) saturate(1.3)';
              debugLog("Video stream started, applied filters");
            });
          } else {
            debugLog("‚ùå Could not find AR video element");
          }
        });
        
        scene.addEventListener('renderstart', () => {
          debugLog("A-Frame rendering started");
        });
      } else {
        debugLog("‚ùå Could not find a-scene element");
      }

      // Target detection events
      const anchor = document.querySelector('#anchor');
      if (anchor) {
        anchor.addEventListener('targetFound', () => {
          debugLog("‚úÖ Image target detected - content should be visible");
        });
        
        anchor.addEventListener('targetLost', () => {
          debugLog("‚ùå Image target lost - content hidden");
        });
      } else {
        debugLog("‚ùå Could not find anchor element");
      }

      const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
      const dormPos = { lat: 14.603919, lng: 120.987760 };

      function createSimpleMapUrl(userPos) {
        return `http://localhost:3001/api/staticmap?userLat=${userPos.lat}&userLng=${userPos.lng}`;
      }

      function setMapTexture(url) {
        if (mapPlane) {
          mapPlane.setAttribute("material", "src", url);
          debugLog(`Map texture set with URL: ${url}`);
        } else {
          debugLog("‚ùå Cannot set map texture - mapPlane not found");
        }
      }

      debugLog("Attempting to get geolocation...");
      navigator.geolocation.getCurrentPosition((position) => {
        const userPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        const mapUrl = createSimpleMapUrl(userPos);
        
        debugLog(`üìç User position: ${JSON.stringify(userPos)}`);
        debugLog(`üó∫Ô∏è Generated map URL: ${mapUrl}`);
        
        setMapTexture(mapUrl);
      }, (err) => {
        debugLog(`‚ùå Geolocation error: ${err.message}`);
        // Fallback map
        const fallbackUrl = "https://maps.googleapis.com/maps/api/staticmap?center=14.603919,120.987760&zoom=15&size=400x300&markers=color:red%7C14.603919,120.987760";
        setMapTexture(fallbackUrl);
        debugLog("Using fallback map image");
      }, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      });

      // Check if all assets are loaded
      window.addEventListener('load', () => {
        debugLog("Page fully loaded");
        
        // Check if MindAR is properly initialized
        if (window.MINDAR) {
          debugLog("MindAR library loaded successfully");
        } else {
          debugLog("‚ùå MindAR library not loaded");
        }
        
        // Check if A-Frame is properly initialized
        if (window.AFRAME) {
          debugLog("A-Frame library loaded successfully");
        } else {
          debugLog("‚ùå A-Frame library not loaded");
        }
      });
    </script>
  </body>
</html>