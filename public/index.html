<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seagold AR Business Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="./assets/mindar/mindar-image-aframe.prod.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="ar-loader">
    <div class="loader-container">
      <img src="./assets/images/seagold-logo.png" class="loader-logo" alt="Seagold Dormitory">
      <div class="loader-spinner">
        <div class="loader-spinner-inner"></div>
        <div class="loader-spinner-inner"></div>
        <div class="loader-spinner-inner"></div>
      </div>
      <h3 class="loader-text">Seagold AR Experience</h3>
      <p class="loader-subtext">Initializing augmented reality for your business dormitory card</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
  </div>

  <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true; uiScanning: true; wasmPath: ./assets/mindar/; filterMinCF: 0.01; filterBeta: 0.001;"
           cursor="rayOrigin: mouse"
           embedded color-space="sRGB"
           renderer="colorManagement: true, physicallyCorrectLights"
           device-orientation-permission-ui="enabled: true"
           shadow="type: pcfsoft">
    <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="-0.5 1 1"></a-entity>
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.3"></a-entity>

    <a-assets>
      <canvas id="cardGradient" width="100" height="100"></canvas>
      <video id="topVideo" src="./assets/images/promo.mp4" loop crossorigin="anonymous" muted playsinline></video>
      <img id="leftImage" src="./assets/images/seagold.png" crossorigin="anonymous">
      <img id="rightImage" src="./assets/images/test.png" crossorigin="anonymous">
      <img id="cardFront" src="./assets/images/ARCARD.png" crossorigin="anonymous">
      <img id="cardBack" src="./assets/images/targets-target.png" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" raycaster="objects: .clickable" cursor="fuse: false; rayOrigin: mouse;"></a-camera>
    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <!-- Right Image -->
      <a-image id="rightImageEntity" class="clickable glow-pulse" src="#rightImage"
               width="0.6" height="0.4" position="0 0.2 0.01" visible="false"
               geometry="primitive: box; depth: 0.03"
               material="side: front; metalness: 0.3; roughness: 0.7"
               animation__slideout="property: position; to: 1.2 0.2 0.01; dur: 1800; delay: 200; easing: easeOutBack; startEvents: startSlideOut"
               animation__visible="property: visible; to: true; startEvents: startSlideOut"
               animation__rotate="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear">
      </a-image>

      <!-- Left Image -->
      <a-image id="leftImageEntity" class="clickable glow-pulse" src="#leftImage"
               width="0.6" height="0.4" position="0 0.2 0.01" visible="false"
               geometry="primitive: box; depth: 0.03"
               material="side: front; metalness: 0.3; roughness: 0.7"
               animation__slideout="property: position; to: -1.2 0.2 0.01; dur: 1800; delay: 800; easing: easeOutBack; startEvents: startSlideOut"
               animation__visible="property: visible; to: true; startEvents: startSlideOut"
               animation__rotate="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear">
      </a-image>

      <!-- Top Video -->
      <a-video id="topVideoEntity" src="#topVideo" width="0.8" height="0.45" position="0 0.2 0.01" visible="false"
               geometry="primitive: plane; depth: 0.05"
               material="side: double; shader: flat"
               animation__slideout="property: position; to: 0 1.2 0.01; dur: 2000; delay: 1400; easing: easeOutCubic; startEvents: startSlideOut"
               animation__visible="property: visible; to: true; startEvents: startSlideOut"
               animation__float="property: rotation; to: 0 5 0; dir: alternate; dur: 4000; loop: true; easing: easeInOutSine">
      </a-video>

      <!-- Centered Card -->
      <a-box id="cardBox" class="clickable glow-pulse" position="0 0.2 0" depth="0.03" height="0.7" width="1.1"
             material="src: #cardFront; side: front; metalness: 0.4; roughness: 0.6"
             shadow="receive: true">
        <a-material src="#cardBack" side="back"></a-material>
        <a-material color="#f2ede3" side="left"></a-material>
        <a-material color="#f2ede3" side="right"></a-material>
        <a-material color="#f2ede3" side="top"></a-material>
        <a-material color="#f2ede3" side="bottom"></a-material>
      </a-box>
      <!-- Visit Button -->
      <a-plane id="visitPlane" class="clickable" position="0 -0.45 0.02"
               width="0.6" height="0.15" color="#00bf63"
               material="shader: flat; transparent: false; opacity: 0.95"
               animation="property: scale; to: 1.05 1.05 1; dir: alternate; loop: true; dur: 1200">
        <a-text value="VISIT OUR WEBSITE" align="center" width="0.8" color="#ffffff"
                font-family="Poppins" font-weight="600" position="0 0 0.01">
        </a-text>
      </a-plane>

      <!-- Map Panel -->
      <a-plane id="mapPlane" position="0 0.2 0.01" width="0.5" height="0.3" opacity="0" visible="false"
               geometry="primitive: plane; depth: 0.03"
               material="shader: standard; metalness: 0.2; roughness: 0.6"
               animation__in="property: position; to: 0 -0.75 0.01; dur: 1600; delay: 2000; easing: easeOutCubic; startEvents: startMapAnim"
               animation__fade="property: material.opacity; to: 1; dur: 1000; easing: easeInOutQuad; startEvents: startMapAnim"
               animation__visible="property: visible; to: true; startEvents: startMapAnim"
               animation__float="property: position; dir: alternate; dur: 3000; loop: true; to: 0 -0.72 0.01; easing: easeInOutSine"
               animation__rotate="property: rotation; to: 0 5 0; dir: alternate; dur: 5000; loop: true; easing: easeInOutSine">
      </a-plane>

      <!-- Particles -->
      <a-entity id="particles">
        <a-circle radius="0.01" color="#4a954e" position="0.5 0.3 0"
                  animation="property: position; to: 0.55 0.35 0; dur: 2000; loop: true; dir: alternate"></a-circle>
        <a-circle radius="0.008" color="#d2a647" position="-0.4 -0.2 0"
                  animation="property: position; to: -0.45 -0.25 0; dur: 2500; loop: true; dir: alternate"></a-circle>
      </a-entity>
    </a-entity>

    <div id="debug-console"></div>
    <script>
      const canvas = document.getElementById('cardGradient');
      const ctx = canvas.getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 100, 100);
      gradient.addColorStop(0, '#f2ede3');
      gradient.addColorStop(1, '#e8e0d0');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, 100, 100);

      const debugConsole = document.getElementById('debug-console');
      function debugLog(msg) {
        if (!debugConsole) return;
        if (debugConsole.children.length > 50) {
          debugConsole.removeChild(debugConsole.firstChild);
        }
        const entry = document.createElement('div');
        entry.textContent = `[DEBUG ${new Date().toLocaleTimeString()}]: ${msg}`;
        debugConsole.appendChild(entry);
        debugConsole.scrollTop = debugConsole.scrollHeight;
        console.log(msg);
      }

      function setupVisitButton() {
        const visitPlane = document.getElementById('visitPlane');
        if (visitPlane) {
          visitPlane.addEventListener('mousedown', () => {
            debugLog("Visit button clicked. Redirecting to website...");
            fetch('https://seagold-dormitory.vercel.app/api/log-visit', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                timestamp: new Date().toISOString(),
                action: 'visit-button-clicked',
                source: 'seagold-ar-business-card'
              })
            }).catch(err => debugLog('Analytics log failed: ' + err.message));
            window.location.href = 'https://seagold-dormitory.vercel.app';
          });
        }
      }

      function scaleForSmallScreens() {
        const anchor = document.getElementById('anchor');
        if (window.innerWidth < 500 && anchor) {
          anchor.setAttribute('scale', '0.8 0.8 0.8');
          debugLog("Scaled scene for small screen");
        }
      }

      function setupMobileInteractions() {
        const clickables = document.querySelectorAll('.clickable');
        clickables.forEach(el => {
          el.addEventListener('touchstart', function (e) {
            e.preventDefault();
            this.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
          }, { passive: false });
        });
        debugLog("Touch compatibility initialized.");
      }

      function handleVideoPlayback() {
        const video = document.querySelector('#topVideo');
        if (!video) return;
        const tryPlay = () => {
          if (video.paused && video.readyState >= 3) {
            video.play().then(() => {
              debugLog("Video playing");
            }).catch(e => {
              debugLog("Video play error: " + e.message);
              setTimeout(tryPlay, 1000);
            });
          }
        };
        tryPlay();
      }

      function enforceVisibility() {
        const anchor = document.getElementById('anchor');
        if (!anchor || anchor.__fixing) return;
        anchor.__fixing = true;
        anchor.setAttribute('visible', 'true');
        const backup = document.createElement('a-entity');
        backup.setAttribute('visible', 'true');
        anchor.appendChild(backup);
        const check = setInterval(() => {
          if (anchor.getAttribute('visible') !== 'true') {
            anchor.setAttribute('visible', 'true');
            backup.setAttribute('visible', 'true');
          }
        }, 100);
        anchor.addEventListener('targetLost', () => {
          clearInterval(check);
          anchor.removeChild(backup);
          anchor.__fixing = false;
        }, { once: true });
      }
      const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
      const dormPos = { lat: 14.603919, lng: 120.987760 };

      function setMapTexture(url) {
        const mapPlane = document.getElementById("mapPlane");
        if (!mapPlane) return;
        const secureUrl = url.startsWith('http:') ? url.replace('http:', 'https:') : url;
        const img = new Image();
        img.onload = () => {
          mapPlane.setAttribute("material", `shader: standard; src: ${secureUrl}; opacity: 0; metalness: 0.2; roughness: 0.6`);
          debugLog(`Map texture loaded`);
        };
        img.onerror = () => {
          mapPlane.setAttribute("material", "shader: standard; color: #4a954e; opacity: 0");
          debugLog("Map load failed.");
        };
        img.src = secureUrl;
      }

      function loadMapWithGeolocation() {
        debugLog("Fetching map...");
        const base = `https://maps.googleapis.com/maps/api/staticmap?center=${dormPos.lat},${dormPos.lng}&zoom=16&size=400x300&markers=color:red%7C${dormPos.lat},${dormPos.lng}&key=${GOOGLE_API_KEY}`;
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const { latitude, longitude } = pos.coords;
              const fullUrl = `${base}&markers=color:blue%7C${latitude},${longitude}`;
              setMapTexture(fullUrl);
            },
            err => {
              debugLog("Geo error: " + err.message);
              setMapTexture(base);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } else {
          debugLog("Geolocation unsupported.");
          setMapTexture(base);
        }
      }

      function setupCardFlip() {
        const card = document.querySelector('#cardBox');
        if (!card) return;
        let isFlipped = false;
        card.addEventListener('mousedown', () => {
          isFlipped = !isFlipped;
          const newRotation = isFlipped ? '0 180 0' : '0 0 0';
          card.setAttribute('animation__flip', {
            property: 'rotation',
            to: newRotation,
            dur: 1000,
            easing: 'easeOutElastic',
            elasticity: 400
          });
          debugLog("Card flipped to: " + newRotation);
        });
      }

      function simulateLoading() {
        const progressFill = document.getElementById('progress-fill');
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            setTimeout(() => {
              document.getElementById('ar-loader').style.opacity = 0;
              setTimeout(() => {
                document.getElementById('ar-loader').style.display = 'none';
              }, 500);
            }, 300);
          }
          progressFill.style.width = `${progress}%`;
        }, 300);
      }

      window.addEventListener('load', () => {
        debugLog("App loaded.");
        simulateLoading();
        setupVisitButton();
        setupMobileInteractions();
        loadMapWithGeolocation();
        scaleForSmallScreens();
        setupCardFlip();

        const scene = document.querySelector('a-scene');
        const anchor = document.getElementById('anchor');

        if (scene && anchor) {
          scene.addEventListener('arReady', () => {
            debugLog("AR system ready");

            anchor.addEventListener('targetFound', () => {
              debugLog("Marker detected. Starting sequential animation...");

              const rightEl = document.querySelector('#rightImageEntity');
              const leftEl = document.querySelector('#leftImageEntity');
              const videoEl = document.querySelector('#topVideoEntity');
              const mapEl = document.querySelector('#mapPlane');

              rightEl.emit('startSlideOut');

              rightEl.addEventListener('animationcomplete__slideout', () => {
                debugLog("Right image done.");
                leftEl.emit('startSlideOut');

                leftEl.addEventListener('animationcomplete__slideout', () => {
                  debugLog("Left image done.");
                  videoEl.emit('startSlideOut');

                  videoEl.addEventListener('animationcomplete__slideout', () => {
                    debugLog("Video animation done.");
                    mapEl.emit('startMapAnim');
                    enforceVisibility();
                    handleVideoPlayback();
                  }, { once: true });
                }, { once: true });
              }, { once: true });
            });

            anchor.addEventListener('targetLost', () => {
              debugLog("Marker lost. Resetting AR elements...");

              const rightEl = document.querySelector('#rightImageEntity');
              rightEl.setAttribute('visible', 'false');
              rightEl.setAttribute('position', '0 0.2 0.01');

              const leftEl = document.querySelector('#leftImageEntity');
              leftEl.setAttribute('visible', 'false');
              leftEl.setAttribute('position', '0 0.2 0.01');

              const videoEl = document.querySelector('#topVideoEntity');
              videoEl.setAttribute('visible', 'false');
              videoEl.setAttribute('position', '0 0.2 0.01');

              const rawVideo = document.querySelector('#topVideo');
              if (rawVideo) {
                rawVideo.pause();
                rawVideo.currentTime = 0;
              }

              const mapEl = document.querySelector('#mapPlane');
              mapEl.setAttribute('visible', 'false');
              mapEl.setAttribute('position', '0 0.2 0.01');
              mapEl.setAttribute('material', 'shader: standard; opacity: 0');

              const card = document.querySelector('#cardBox');
              if (card) {
                card.setAttribute('rotation', '0 0 0');
                card.removeAttribute('animation__flip');
              }

              anchor.__fixing = false;
            });
          });
        }
      });
    </script>
  </a-scene>
</body>
</html>
